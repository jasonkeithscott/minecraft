---

  - name: Download minecraft server jar
    hosts: localhost

    vars:

      version_manifest_url: https://launchermeta.mojang.com/mc/game/version_manifest.json

    tasks:

      - name: Get url json
        uri:
          url: "{{ version_manifest_url }}"
          follow_redirects: safe
          return_content: yes
        register: version_manifest_url_result

      - name: Convert if not application/json
        set_fact:
          version_manifest_url_json: "{{ version_manifest_url_result.content | from_json }}"
        when: "version_manifest_url_result.content_type != 'application/json'"

      - name: Content already application/json
        set_fact:
          version_manifest_url_json: "{{ version_manifest_url_result.content }}"
        when: "version_manifest_url_result.content_type == 'application/json'"

      - name: Set fact latest release value
        set_fact:
          latest_release: "{{ version_manifest_url_json | json_query('latest.release') }}"

      - name: Debug
        debug:
          var: latest_release

      # TODO: Query local fs for server jar version
      # Compare to latest_release and determine if download
      # is needed or exit.

      - name: Set fact query meta url {{ latest_release }}
        set_fact:
          query: "versions[?id == '{{ latest_release }}'].url"

      - name: Get meta url {{ latest_release }}
        debug:
          msg: "{{ version_manifest_url_json | json_query(query) }}"


